<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NY Affordability Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Helvetica', Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .chart-container {
            height: 800px;
            overflow-x: auto;
            overflow-y: auto;
            margin-bottom: 40px;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .heatmap-container {
            height: 800px;
            margin-bottom: 40px;
            border: 1px solid #ddd;
            background-color: #fff;
        }
        select {
            margin: 10px 0;
            padding: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NY Affordability Visualization</h1>
        
        <!-- Dropdown Filter with finer ranges -->
        <select id="zipFilter" onchange="filterChart()">
            <option value="all">All ZIP Codes</option>
            <option value="06000-06499">06000-06499</option>
            <option value="06500-06999">06500-06999</option>
            <option value="10000-10499">10000-10499</option>
            <option value="10500-10999">10500-10999</option>
            <option value="11000-11499">11000-11499</option>
            <option value="11500-11999">11500-11999</option>
            <option value="12000-12499">12000-12499</option>
            <option value="12500-12999">12500-12999</option>
            <option value="13000-13499">13000-13499</option>
            <option value="13500-13999">13500-13999</option>
            <option value="14000-14499">14000-14499</option>
            <option value="14500-14999">14500-14999</option>
        </select>

        <div class="chart-container">
            <canvas id="affordabilityChart"></canvas>
        </div>

        <div class="heatmap-container" id="heatmapMap"></div>
    </div>

    <script>
        // Bar Chart Data
        const zipCodes = {{ zip_codes | tojson }};
        const overallScores = {{ overall_scores | tojson }};

        // Filter function
        function filterChart() {
            const filter = document.getElementById('zipFilter').value;
            let filteredZipCodes, filteredScores;
            if (filter === 'all') {
                filteredZipCodes = zipCodes;
                filteredScores = overallScores;
            } else {
                const [min, max] = filter.split('-').map(Number);
                filteredZipCodes = zipCodes.filter(z => {
                    const zipNum = parseInt(z);
                    return zipNum >= min && zipNum <= max;
                });
                filteredScores = filteredZipCodes.map(z => {
                    const index = zipCodes.indexOf(z);
                    return index !== -1 ? overallScores[index] : 50.0;
                });
            }
            updateChart(filteredZipCodes, filteredScores);
        }

        // Initialize Chart
        let barChart;
        function updateChart(labels, data) {
            const barCtx = document.getElementById('affordabilityChart').getContext('2d');
            if (barChart) barChart.destroy();
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Overall Score',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Overall Score (0-100)' }
                        },
                        x: {
                            title: { display: true, text: 'ZIP Codes' },
                            ticks: { autoSkip: false, maxRotation: 90, minRotation: 90 }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        filterChart(); // Initial load with all ZIP codes

        // Heatmap Data
        const latitudes = {{ latitudes | tojson }};
        const longitudes = {{ longitudes | tojson }};
        const normalizedScores = {{ normalized_scores | tojson }};

        // Heatmap using Leaflet with GeoJSON, limited to NY
        const map = L.map('heatmapMap').setView([40.7128, -74.0060], 7);  // Center on NYC, NY state focus
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 10,
            minZoom: 6
        }).addTo(map);

        // Load GeoJSON and color by normalized score
        fetch('/static/ny_zip_codes.json')
            .then(response => response.json())
            .then(geojson => {
                const matchedZips = [];
                L.geoJSON(geojson, {
                    style: function(feature) {
                        const zip = feature.properties.ZCTA5CE10.toString();  // Ensure string comparison
                        const index = zipCodes.indexOf(zip);
                        if (index !== -1) matchedZips.push(zip);
                        const score = (index !== -1) ? normalizedScores[index] : 0;
                        return {
                            fillColor: getColor(score),
                            weight: 2,  // Thicker borders for visibility
                            opacity: 1,
                            color: 'black',  // Clear section boundaries
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const zip = feature.properties.ZCTA5CE10.toString();
                        const index = zipCodes.indexOf(zip);
                        const score = (index !== -1) ? overallScores[index].toFixed(2) : 'N/A';
                        layer.bindPopup(`ZIP: ${zip}<br>Overall Score: ${score}`);
                        layer.on('mouseover', function(e) {
                            layer.setStyle({ fillOpacity: 0.9 });
                        });
                        layer.on('mouseout', function(e) {
                            layer.setStyle({ fillOpacity: 0.7 });
                        });
                    }
                }).addTo(map);
                console.log("Matched ZIPs:", matchedZips);  // Debug matched ZIPs
            })
            .catch(error => console.error('Error loading GeoJSON:', error));

        function getColor(d) {
            return d > 0.8 ? '#800026' :
                   d > 0.6 ? '#BD0026' :
                   d > 0.4 ? '#E31A1C' :
                   d > 0.2 ? '#FC4E2A' :
                   d > 0   ? '#FD8D3C' :
                             '#FFEDA0';
        }
    </script>
</body>
</html>